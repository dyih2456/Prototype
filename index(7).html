
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة طلبات التوصيل</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --font-family: 'Tahoma', 'Segoe UI', 'Roboto', sans-serif;
            --base-font-size: 16px; /* Base font size for rem calculations */
        }

        html {
            font-size: var(--base-font-size);
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: var(--dark-color);
            line-height: 1.6;
            font-size: 1rem; /* 16px by default */
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        header h1 {
            margin: 0;
            font-size: 1.75rem; 
        }

        main {
            padding: 1rem;
            max-width: 1200px;
            margin: 1rem auto;
        }

        section {
            background-color: white;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        }

        h2, h3 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
            margin-top: 0;
            margin-bottom: 1rem; 
        }
        
        h2 {
           font-size: 1.6rem;
        }

        h3 {
            font-size: 1.3rem;
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem; 
        }

        .agent-card { /* Renamed from driver-card */
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1.25rem; 
            background-color: var(--light-color);
            transition: box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            position: relative; /* For action menu positioning */
        }

        .agent-card:hover { /* Renamed from driver-card */
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
        }

        .agent-card h4 { /* Renamed from driver-card */
            margin-top: 0;
            margin-bottom: 0.75rem; 
            color: var(--dark-color);
            font-size: 1.15rem;
        }
        .agent-card p { /* Renamed from driver-card */
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .agent-card-actions { /* Renamed from driver-card-actions */
            margin-top: auto; 
            padding-top: 0.75rem; 
            display: flex;
            flex-direction: column; 
            gap: 0.5rem; 
        }

        .agent-card-actions button { /* Renamed from driver-card-actions */
            width: 100%; 
        }


        button, select, input[type="text"], input[type="tel"], textarea, input[type="file"] {
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: var(--font-family);
            font-size: 0.95rem; 
            margin-bottom: 0.75rem; 
            box-sizing: border-box;
            width: 100%;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            border: none;
            font-weight: bold;
        }

        button:hover {
            background-color: #0056b3;
        }
        button:active {
            transform: translateY(1px);
        }
        
        button.secondary {
            background-color: var(--secondary-color);
        }
        button.secondary:hover {
            background-color: #545b62;
        }

        button.success { background-color: var(--success-color); }
        button.success:hover { background-color: #1e7e34; }

        button.danger { background-color: var(--danger-color); }
        button.danger:hover { background-color: #b02a37; }

        button.warning { background-color: var(--warning-color); color: var(--dark-color); }
        button.warning:hover { background-color: #d39e00; }
        
        button.info { background-color: var(--info-color); }
        button.info:hover { background-color: #117a8b; }

        .action-buttons-group {
            margin-top: 1rem;
            margin-bottom: 1rem; /* Added margin for spacing */
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
         .action-buttons-group button, .action-buttons-group .file-input-label {
            flex-grow: 1;
            min-width: 150px;
         }

        .file-input-label {
            display: inline-block;
            padding: 0.75rem;
            background-color: var(--info-color);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .file-input-label:hover {
            background-color: #117a8b;
        }
        #importDataInput {
            display: none;
        }


        .table-responsive-wrapper {
            overflow-x: auto;
            margin-top: 1rem;
            border: 1px solid #ddd; 
            border-radius: 4px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px; /* Adjusted min width */
        }

        th, td {
            border: 1px solid #ddd;
            padding: 0.5rem; /* Reduced padding further */
            text-align: right;
            vertical-align: middle; 
            font-size: 0.8rem; /* Reduced font size further */
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            font-size: 0.8rem; /* Reduced font size */
        }

        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tbody tr:hover {
            background-color: #f1f1f1;
        }

        .table-action-button {
            font-size: 0.8rem;
            padding: 0.4rem 0.6rem;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 0.35rem;
        }
        .table-action-button:last-child {
            margin-bottom: 0;
        }


        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
            align-items: center;
            justify-content: center;
            padding: 1rem; 
            box-sizing: border-box;
        }

        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 1.5rem 2rem; 
            border: 1px solid #888;
            width: 100%; 
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            max-height: 90vh; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column;
        }
        .modal-content.modal-lg {
             max-width: 800px;
        }

        .modal-content form {
            display: flex;
            flex-direction: column;
            gap: 0.5rem; 
        }
        .modal-content form button[type="submit"] {
            margin-top: 1rem; 
        }


        .close-btn {
            color: #aaa;
            position: absolute;
            left: 15px; /* RTL */
            top: 10px;
            font-size: 1.75rem; 
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
        }

        .hidden {
            display: none !important;
        }
        
        .status-badge {
            padding: 0.3em 0.6em;
            border-radius: 0.25em;
            font-size: 0.8em; 
            color: white;
            white-space: nowrap;
            display: inline-block; 
        }
        .status-مع-المندوب { background-color: var(--info-color); }
        .status-تم-التسليم { background-color: var(--success-color); }
        .status-ملغي { background-color: var(--danger-color); }
        .status-مؤجل { background-color: var(--warning-color); color: var(--dark-color); }
        .status-واصل-جزئي { background-color: var(--secondary-color); }
        
        .status-update-specific-note {
            font-size: 0.75em; 
            color: var(--secondary-color);
            margin-right: 0.4em; /* RTL: margin-right */
            font-style: italic;
        }


        .search-container {
            margin-bottom: 1rem;
        }
        .search-container input {
            padding: 0.6rem; 
        }

        label {
            display: block;
            margin-bottom: 0.4rem; 
            font-weight: bold;
            color: var(--dark-color);
            font-size: 0.9rem;
        }
        
        .agent-details-header { 
            display: flex;
            justify-content: space-between;
            align-items: flex-start; 
            position: relative; 
        }

        #agent-details-info { 
            margin-bottom: 1.5rem; 
            flex-grow: 1; 
        }
        #agent-details-info p { 
            margin: 0.5rem 0;
            font-size: 1.05rem; 
        }
        #agent-details-info strong { 
            color: var(--primary-color);
        }
        #agent-details-section .button-group { 
            display: flex;
            gap: 0.5rem; 
            flex-wrap: wrap; 
            margin-bottom: 1rem;
        }
        #agent-details-section .button-group button { 
            flex-grow: 1; 
             min-width: 150px; 
        }

        .order-history-list {
            list-style-type: none;
            padding: 0;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .order-history-list li {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
        }
        .order-history-list li:last-child {
            border-bottom: none;
        }
        .order-history-list .history-status {
            font-weight: bold;
        }
        .order-history-list .history-time {
            font-size: 0.85em;
            color: var(--secondary-color);
            display: block;
            margin-top: 0.25em;
        }
        .order-history-list .history-note {
            font-size: 0.9em;
            color: var(--dark-color);
            margin-top: 0.4em;
            padding-right: 1em; 
            border-right: 2px solid var(--primary-color);
            display: block; 
            word-wrap: break-word;
        }
        
        /* Action Menu Styles */
        .action-menu-container {
            position: relative;
            display: inline-block; 
        }
        
        .action-menu-toggle {
            background: none;
            border: none;
            color: var(--secondary-color);
            font-size: 1.5rem; 
            padding: 0.25rem 0.5rem; 
            cursor: pointer;
            line-height: 1; 
        }
        .action-menu-toggle:hover {
            color: var(--primary-color);
            background-color: transparent; 
        }

        .action-menu-content {
            display: none;
            position: absolute;
            left: 0; 
            top: 100%; 
            background-color: white;
            width: max-content; /* Adjust width to content for horizontal layout */
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1001; 
            border-radius: 4px;
            padding: 0.5rem; /* Uniform padding */
            flex-direction: row; /* For horizontal layout (set display:flex on .show) */
            gap: 0.5rem; /* Spacing between horizontal buttons */
        }
        .action-menu-content.show {
            display: flex; /* Changed from block to flex for horizontal layout */
        }
        .action-menu-content button {
            width: auto; /* Allow buttons to size based on content */
            padding: 0.6rem 0.8rem; 
            text-align: center; /* Center text for horizontal buttons */
            background-color: transparent;
            color: var(--dark-color);
            border: none;
            font-size: 0.8rem; /* Adjusted font size for compactness */
            white-space: nowrap; /* Prevent button text from wrapping */
        }
        .action-menu-content button:hover {
            background-color: #f1f1f1;
            color: var(--primary-color);
        }
        .agent-card .action-menu-container { 
             position: absolute;
             top: 0.75rem;
             left: 0.75rem; 
        }
         .order-actions-cell { 
            position: relative; 
            text-align: center; 
        }


        /* Responsive Adjustments */
        @media (max-width: 768px) {
            html {
                font-size: 15px; 
            }
            header h1 {
                font-size: 1.5rem;
            }
            main {
                padding: 0.75rem;
                margin: 0.75rem auto;
            }
            section {
                padding: 1rem;
            }
            h2 {
                font-size: 1.4rem;
            }
            h3 {
                font-size: 1.2rem;
            }
            .cards-container {
                gap: 1rem;
            }
            .agent-card { 
                padding: 1rem;
            }
             th, td {
                padding: 0.4rem; /* Further reduced padding */
                font-size: 0.75rem; /* Further reduced font size */
            }
            th {
                font-size: 0.7rem; /* Further reduced font size */
            }
            button, select, input[type="text"], input[type="tel"], textarea, input[type="file"], .file-input-label {
                font-size: 0.9rem;
                padding: 0.65rem;
            }
            #agent-details-info p { 
                font-size: 1rem;
            }
            .modal-content {
                padding: 1.5rem;
                max-width: 90vw; 
            }
            .modal-content.modal-lg {
                max-width: 95vw; 
            }
             #agent-details-section .button-group button { 
                width: 100%; 
                flex-grow: 0;
            }
            .action-buttons-group button, .action-buttons-group .file-input-label {
                width: 100%;
                flex-grow: 0; 
            }
             .action-menu-toggle {
                padding: 0.4rem 0.6rem; 
                font-size: 1.6rem;
            }
            /* For smaller screens, action menu might need to revert to vertical or stack */
            .action-menu-content {
                /* Consider making it wrap or stack on very small screens if it overflows */
                flex-wrap: wrap; /* Allow buttons to wrap if not enough horizontal space */
            }
        }

        @media (max-width: 480px) {
            html {
                font-size: 14px; 
            }
            main {
                padding: 0.5rem; 
            }
            header h1 {
                font-size: 1.3rem;
            }
            section {
                padding: 0.75rem;
            }
            .modal-content {
                padding: 1rem 1.25rem;
                max-width: 95vw; 
            }
            label {
                font-size: 0.85rem;
            }
             th, td {
                padding: 0.3rem; /* Further reduced padding */
                font-size: 0.7rem; /* Reduced font size */
            }
            th {
                font-size: 0.65rem; /* Reduced font size */
            }
            .status-badge {
                font-size: 0.7em; 
            }
            .order-history-list .history-time {
                font-size: 0.8em;
            }
            .order-history-list .history-note {
                font-size: 0.85em;
            }
            .status-update-specific-note {
                font-size: 0.7em; 
            }
            .action-menu-toggle {
                padding: 0.5rem; 
                font-size: 1.7rem; 
            }
            .action-menu-content button {
                font-size: 0.75rem; /* Slightly smaller buttons in menu for small screens */
                padding: 0.5rem 0.7rem;
            }
        }

    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <header>
        <h1>prototype</h1>
    </header>

    <main>
        <section id="agents-section" aria-labelledby="agents-heading">
            <h2 id="agents-heading">قائمة المندوبين</h2>
            <div class="action-buttons-group">
                <button id="showAddAgentModalBtn" aria-label="إضافة مندوب جديد">إضافة مندوب جديد</button>
                <button id="exportReportBtn" class="info" aria-label="تصدير تقرير CSV">تصدير تقرير CSV</button>
                <button id="exportDataBtn" class="info" aria-label="تصدير البيانات JSON">تصدير البيانات (JSON)</button>
                <label for="importDataInput" class="file-input-label info" aria-label="استيراد البيانات JSON">استيراد البيانات (JSON)</label>
                <input type="file" id="importDataInput" accept=".json">
                <button id="deleteAllAgentsBtn" class="danger" aria-label="حذف جميع المندوبين">حذف جميع المندوبين</button>
            </div>
            <div id="agents-list" class="cards-container">
                <!-- Agent cards will be dynamically inserted here -->
            </div>
        </section>

        <section id="agent-details-section" class="hidden" aria-live="polite" aria-labelledby="agent-details-name-heading">
            <div class="agent-details-header">
                <div id="agent-details-info">
                    <h2 id="agent-details-name-heading">تفاصيل المندوب: <span id="agent-details-name"></span></h2>
                    <p><strong>الهاتف:</strong> <span id="agent-details-phone"></span></p>
                    <p><strong>المنطقة:</strong> <span id="agent-details-area"></span></p>
                    <p><strong>الطلبات النشطة:</strong> <span id="agent-details-active-orders"></span></p>
                    <p><strong>إجمالي الطلبات:</strong> <span id="agent-details-total-orders"></span></p>
                </div>
                <div class="action-menu-container" id="current-agent-action-menu-container">
                    <button class="action-menu-toggle" aria-label="خيارات المندوب الحالي" data-target-menu="current-agent-action-menu">&#8942;</button>
                    <div id="current-agent-action-menu" class="action-menu-content">
                        <button id="deleteCurrentAgentMenuBtn" class="danger">حذف هذا المندوب</button>
                    </div>
                </div>
            </div>
            <div class="button-group">
                <button id="showAddOrderModalBtn" aria-label="إضافة طلب جديد لهذا المندوب">إضافة طلب جديد</button>
                <button id="deleteAllOrdersForCurrentAgentBtn" class="danger" aria-label="حذف جميع طلبات هذا المندوب">حذف جميع طلبات هذا المندوب</button>
                <button id="backToAgentsListBtn" class="secondary" aria-label="العودة إلى قائمة المندوبين">العودة لقائمة المندوبين</button>
            </div>
            
            <h3>قائمة الطلبات</h3>
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="بحث برقم الوصل أو هاتف الزبون..." aria-label="بحث في الطلبات">
            </div>
            <div class="table-responsive-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>نوع الطلب</th>
                            <th>رقم الوصل</th>
                            <th>هاتف الزبون</th>
                            <th>الحالة</th>
                            <th>ملاحظة رئيسية</th>
                            <th>تاريخ الإضافة</th>
                            <th>إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body">
                        <!-- Order rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
            <p id="no-orders-message" class="hidden" style="text-align: center; padding: 1rem; color: var(--secondary-color);">لا توجد طلبات لعرضها.</p>
        </section>
    </main>

    <!-- Add Agent Modal -->
    <div id="addAgentModal" class="modal" role="dialog" aria-labelledby="addAgentModalTitle" aria-hidden="true">
        <div class="modal-content">
            <span class="close-btn" data-modal-id="addAgentModal" aria-label="إغلاق">&times;</span>
            <h3 id="addAgentModalTitle">إضافة مندوب جديد</h3>
            <form id="addAgentForm">
                <div>
                    <label for="agentName">الاسم الكامل:</label>
                    <input type="text" id="agentName" required>
                </div>
                <div>
                    <label for="agentPhone">رقم الهاتف:</label>
                    <input type="tel" id="agentPhone" required pattern="[0-9]{10,15}">
                </div>
                <div>
                    <label for="agentArea">المنطقة:</label>
                    <input type="text" id="agentArea" required>
                </div>
                <button type="submit" class="success">إضافة المندوب</button>
            </form>
        </div>
    </div>

    <!-- Add Order Modal -->
    <div id="addOrderModal" class="modal" role="dialog" aria-labelledby="addOrderModalTitle" aria-hidden="true">
        <div class="modal-content">
            <span class="close-btn" data-modal-id="addOrderModal" aria-label="إغلاق">&times;</span>
            <h3 id="addOrderModalTitle">إضافة طلب جديد لـ <span id="addOrderModalAgentName"></span></h3>
            <form id="addOrderForm">
                <input type="hidden" id="orderAgentId">
                <div>
                    <label for="orderType">نوع الطلب:</label>
                    <input type="text" id="orderType" required>
                </div>
                <div>
                    <label for="receiptNumber">رقم الوصل:</label>
                    <input type="text" id="receiptNumber" required>
                </div>
                <div>
                    <label for="customerPhone">رقم هاتف الزبون:</label>
                    <input type="tel" id="customerPhone" required pattern="[0-9]{10,15}">
                </div>
                <div>
                    <label for="orderNote">ملاحظة رئيسية (اختياري):</label>
                    <textarea id="orderNote" rows="3"></textarea>
                </div>
                <button type="submit" class="success">إضافة الطلب</button>
            </form>
        </div>
    </div>

    <!-- Update Status Modal -->
    <div id="updateStatusModal" class="modal" role="dialog" aria-labelledby="updateStatusModalTitle" aria-hidden="true">
        <div class="modal-content">
            <span class="close-btn" data-modal-id="updateStatusModal" aria-label="إغلاق">&times;</span>
            <h3 id="updateStatusModalTitle">تحديث حالة الطلب</h3>
            <form id="updateStatusForm">
                <input type="hidden" id="updateStatusOrderId">
                <input type="hidden" id="updateStatusAgentId">
                <div>
                    <label for="orderStatus">الحالة الجديدة:</label>
                    <select id="orderStatus">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div>
                    <label for="statusUpdateNote">ملاحظة تحديث الحالة (اختياري):</label>
                    <textarea id="statusUpdateNote" rows="2"></textarea>
                </div>
                <button type="submit" class="success">تحديث الحالة</button>
            </form>
        </div>
    </div>

    <!-- Order History Modal -->
    <div id="orderHistoryModal" class="modal" role="dialog" aria-labelledby="orderHistoryModalTitle" aria-hidden="true">
        <div class="modal-content modal-lg">
            <span class="close-btn" data-modal-id="orderHistoryModal" aria-label="إغلاق">&times;</span>
            <h3 id="orderHistoryModalTitle">سجل تحديثات الطلب رقم: <span id="historyOrderReceiptNumber"></span></h3>
            <ul id="orderHistoryList" class="order-history-list">
                <!-- History items will be populated here -->
            </ul>
             <p id="no-history-message" class="hidden" style="text-align: center; padding: 1rem; color: var(--secondary-color);">لا يوجد سجل تحديثات لهذا الطلب.</p>
        </div>
    </div>


    <script>
        const AGENTS_STORAGE_KEY = 'DELIVERY_AGENTS_DATA_V4'; // Renamed and version bumped
        let agents = []; // Renamed from drivers
        let nextAgentId = 1; // Renamed
        let nextOrderId = 1;
        let currentlyViewingAgentId = null; // Renamed

        const ORDER_STATUSES = ["مع المندوب", "تم التسليم", "ملغي", "مؤجل", "واصل جزئي"];
        const DEFAULT_ORDER_STATUS = "مع المندوب";
        const INACTIVE_STATUSES = ["تم التسليم", "ملغي"];

        // DOM Elements
        const agentsListDiv = document.getElementById('agents-list'); // Renamed
        const agentsSection = document.getElementById('agents-section'); // Renamed
        const agentDetailsSection = document.getElementById('agent-details-section'); // Renamed
        const agentDetailsNameSpan = document.getElementById('agent-details-name'); // Renamed
        const agentDetailsPhoneSpan = document.getElementById('agent-details-phone'); // Renamed
        const agentDetailsAreaSpan = document.getElementById('agent-details-area'); // Renamed
        const agentDetailsActiveOrdersSpan = document.getElementById('agent-details-active-orders'); // Renamed
        const agentDetailsTotalOrdersSpan = document.getElementById('agent-details-total-orders'); // New
        const ordersTableBody = document.getElementById('orders-table-body');
        const noOrdersMessage = document.getElementById('no-orders-message');
        const searchInput = document.getElementById('searchInput');

        // Modal Elements
        const addAgentModal = document.getElementById('addAgentModal'); // Renamed
        const addOrderModal = document.getElementById('addOrderModal');
        const updateStatusModal = document.getElementById('updateStatusModal');
        const orderHistoryModal = document.getElementById('orderHistoryModal');
        const addAgentForm = document.getElementById('addAgentForm'); // Renamed
        const addOrderForm = document.getElementById('addOrderForm');
        const updateStatusForm = document.getElementById('updateStatusForm');
        const addOrderModalAgentNameSpan = document.getElementById('addOrderModalAgentName'); // Renamed
        const orderStatusSelect = document.getElementById('orderStatus');
        const statusUpdateNoteTextarea = document.getElementById('statusUpdateNote');
        const orderHistoryListUl = document.getElementById('orderHistoryList');
        const historyOrderReceiptNumberSpan = document.getElementById('historyOrderReceiptNumber');
        const noHistoryMessage = document.getElementById('no-history-message');


        // Buttons
        const showAddAgentModalBtn = document.getElementById('showAddAgentModalBtn'); // Renamed
        const showAddOrderModalBtn = document.getElementById('showAddOrderModalBtn');
        const backToAgentsListBtn = document.getElementById('backToAgentsListBtn'); // Renamed
        const deleteAllAgentsBtn = document.getElementById('deleteAllAgentsBtn'); // Renamed
        const exportReportBtn = document.getElementById('exportReportBtn');
        // const deleteCurrentAgentBtn = document.getElementById('deleteCurrentAgentBtn'); // Removed, replaced by menu
        const deleteAllOrdersForCurrentAgentBtn = document.getElementById('deleteAllOrdersForCurrentAgentBtn'); // Renamed
        const exportDataBtn = document.getElementById('exportDataBtn');
        const importDataInput = document.getElementById('importDataInput');
        
        
        // --- Data Persistence ---
        function loadData() {
            const data = localStorage.getItem(AGENTS_STORAGE_KEY);
            if (data) {
                try {
                    const parsedData = JSON.parse(data);
                    if (parsedData && Array.isArray(parsedData.agents) && 
                        typeof parsedData.nextAgentId === 'number' && 
                        typeof parsedData.nextOrderId === 'number') {
                        
                        agents = parsedData.agents;
                        nextAgentId = parsedData.nextAgentId;
                        nextOrderId = parsedData.nextOrderId;
                        
                        // Data migration/validation for orders (if needed from older structures)
                        agents.forEach(agent => {
                            if (agent.orders) {
                                agent.orders.forEach(order => {
                                    if (!order.statusHistory || order.statusHistory.length === 0) { 
                                        order.statusHistory = [{
                                            status: order.status || DEFAULT_ORDER_STATUS,
                                            timestamp: order.date || new Date().toISOString(),
                                            note: "" 
                                        }];
                                    }
                                    if (order.statusHistory.length > 0) {
                                       order.status = order.statusHistory[order.statusHistory.length - 1].status;
                                    } else { 
                                       order.status = DEFAULT_ORDER_STATUS;
                                        order.statusHistory = [{
                                            status: DEFAULT_ORDER_STATUS,
                                            timestamp: order.date || new Date().toISOString(),
                                            note: "" 
                                        }];
                                    }
                                });
                            } else {
                                agent.orders = []; // Ensure orders array exists
                            }
                        });

                    } else if (Array.isArray(parsedData)) { // Handle old direct array storage for compatibility
                        agents = parsedData;
                        nextAgentId = agents.length > 0 ? Math.max(0, ...agents.map(d => d.id || 0)) + 1 : 1;
                        const allOrderIds = agents.flatMap(d => (d.orders || []).map(o => o.id || 0));
                        nextOrderId = allOrderIds.length > 0 ? Math.max(0, ...allOrderIds) + 1 : 1;
                         // Apply same migration/validation as above
                        agents.forEach(agent => {
                            if (agent.orders) {
                                agent.orders.forEach(order => {
                                    if (!order.statusHistory || order.statusHistory.length === 0) { /*...*/ }
                                    // ... (rest of migration logic)
                                });
                            } else {
                                agent.orders = [];
                            }
                        });

                    } else {
                        agents = []; nextAgentId = 1; nextOrderId = 1;
                    }
                } catch (e) {
                    console.error("Error parsing data from localStorage:", e);
                    agents = []; nextAgentId = 1; nextOrderId = 1;
                }
            } else {
                 agents = []; nextAgentId = 1; nextOrderId = 1;
            }
        }

        function saveData() {
            const dataToSave = {
                agents: agents,
                nextAgentId: nextAgentId,
                nextOrderId: nextOrderId
            };
            localStorage.setItem(AGENTS_STORAGE_KEY, JSON.stringify(dataToSave));
        }

        // --- Utility Functions ---
        function getActiveOrdersCount(agent) { // Renamed parameter
            if (!agent || !agent.orders) return 0;
            return agent.orders.filter(order => {
                const currentStatusEntry = order.statusHistory[order.statusHistory.length - 1];
                const currentStatus = currentStatusEntry ? currentStatusEntry.status : DEFAULT_ORDER_STATUS;
                return !INACTIVE_STATUSES.includes(currentStatus);
            }).length;
        }

        function getAgentTotalOrdersCount(agent) {
            return agent && agent.orders ? agent.orders.length : 0;
        }

        function formatDate(dateString) { 
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                return `${day}/${month}`;
            } catch (e) {
                console.error("Error formatting date (DD/MM):", e);
                return 'تاريخ غير صالح';
            }
        }
        
        function formatDateTime(dateString) { 
             if (!dateString) return '';
            try {
                const date = new Date(dateString);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            } catch (e) {
                console.error("Error formatting date-time:", e);
                return 'تاريخ-وقت غير صالح';
            }
        }

        function formatDateTimeForReport(dateString) {
             return formatDateTime(dateString);
        }
        
        function sanitizeHTML(str) {
            if (typeof str !== 'string') str = String(str);
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

        // --- Modal Management ---
        function openModal(modalElement) {
            modalElement.style.display = 'flex';
            modalElement.setAttribute('aria-hidden', 'false');
            const focusable = modalElement.querySelector('input, select, textarea, button');
            if (focusable) focusable.focus();
        }

        function closeModal(modalElement) {
            modalElement.style.display = 'none';
            modalElement.setAttribute('aria-hidden', 'true');
        }

        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.onclick = (e) => {
                e.stopPropagation();
                closeModal(document.getElementById(btn.dataset.modalId));
            }
        });

        window.onclick = (event) => {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target);
            }
            // Close action menus if click is outside
            document.querySelectorAll('.action-menu-content.show').forEach(menu => {
                if (!menu.contains(event.target) && !event.target.closest('.action-menu-toggle')) {
                    menu.classList.remove('show');
                }
            });
        };
        
        function populateStatusSelect(selectElement, selectedStatus = null) {
            selectElement.innerHTML = '';
            ORDER_STATUSES.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                if (status === selectedStatus) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        }
        populateStatusSelect(orderStatusSelect);


        // --- Rendering Functions ---
        function renderAgentsList() { // Renamed
            agentsListDiv.innerHTML = '';
            if (agents.length === 0) {
                agentsListDiv.innerHTML = '<p style="text-align:center; grid-column: 1 / -1; color: var(--secondary-color);">لا يوجد مندوبون مضافون حاليًا. ابدأ بإضافة مندوب جديد.</p>';
                deleteAllAgentsBtn.classList.add('hidden'); 
                exportReportBtn.classList.add('hidden'); 
                exportDataBtn.classList.add('hidden');
                document.querySelector('label[for="importDataInput"]').classList.add('hidden');
                return;
            }
            deleteAllAgentsBtn.classList.remove('hidden');
            exportReportBtn.classList.remove('hidden');
            exportDataBtn.classList.remove('hidden');
            document.querySelector('label[for="importDataInput"]').classList.remove('hidden');


            agents.forEach(agent => {
                const activeOrdersCount = getActiveOrdersCount(agent);
                const totalOrdersCount = getAgentTotalOrdersCount(agent);
                const card = document.createElement('div');
                card.className = 'agent-card'; // Renamed
                card.innerHTML = `
                    <div class="action-menu-container">
                        <button class="action-menu-toggle" aria-label="خيارات المندوب ${sanitizeHTML(agent.name)}" data-target-menu="agent-menu-${agent.id}">&#8942;</button>
                        <div id="agent-menu-${agent.id}" class="action-menu-content">
                            <button data-agent-id="${agent.id}" class="delete-agent-btn danger">حذف المندوب</button>
                        </div>
                    </div>
                    <h4>${sanitizeHTML(agent.name)}</h4>
                    <p><strong>الهاتف:</strong> ${sanitizeHTML(agent.phone)}</p>
                    <p><strong>المنطقة:</strong> ${sanitizeHTML(agent.area)}</p>
                    <p><strong>الطلبات النشطة:</strong> ${activeOrdersCount}</p>
                    <p><strong>إجمالي الطلبات:</strong> ${totalOrdersCount}</p>
                    <div class="agent-card-actions">
                        <button data-agent-id="${agent.id}" class="view-details-btn">عرض التفاصيل</button>
                    </div>
                `;
                agentsListDiv.appendChild(card);
            });

            document.querySelectorAll('.view-details-btn').forEach(btn => {
                btn.onclick = () => showAgentDetails(parseInt(btn.dataset.agentId));
            });
            document.querySelectorAll('.delete-agent-btn').forEach(btn => {
                btn.onclick = (e) => {
                     e.stopPropagation(); // Prevent card click if menu is open
                    deleteAgent(parseInt(btn.dataset.agentId));
                    const menuId = btn.closest('.action-menu-content').id;
                    document.getElementById(menuId).classList.remove('show'); // Close menu
                }
            });
            setupActionMenuToggleListeners();
        }

        function renderAgentDetails(agentId, searchTerm = '') { // Renamed
            const agent = agents.find(d => d.id === agentId);
            if (!agent) {
                console.error("Agent not found for ID:", agentId);
                backToAgentsList();
                return;
            }

            currentlyViewingAgentId = agentId;
            agentDetailsNameSpan.textContent = sanitizeHTML(agent.name);
            document.querySelector('#agent-details-name-heading #agent-details-name').textContent = sanitizeHTML(agent.name); 
            agentDetailsPhoneSpan.textContent = sanitizeHTML(agent.phone);
            agentDetailsAreaSpan.textContent = sanitizeHTML(agent.area);
            agentDetailsActiveOrdersSpan.textContent = getActiveOrdersCount(agent);
            agentDetailsTotalOrdersSpan.textContent = getAgentTotalOrdersCount(agent);
            
            // Setup action menu for current agent details
            const currentAgentActionMenuContainer = document.getElementById('current-agent-action-menu-container');
            if(currentAgentActionMenuContainer) currentAgentActionMenuContainer.classList.remove('hidden');
            const deleteCurrentAgentMenuBtn = document.getElementById('deleteCurrentAgentMenuBtn');
            if (deleteCurrentAgentMenuBtn) {
                deleteCurrentAgentMenuBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteAgent(currentlyViewingAgentId);
                     document.getElementById('current-agent-action-menu').classList.remove('show');
                };
            }


            ordersTableBody.innerHTML = '';
            
            const agentOrders = agent.orders || [];
            const filteredOrders = agentOrders.filter(order => {
                const term = searchTerm.toLowerCase().trim();
                if (!term) return true;
                return (order.receiptNumber && order.receiptNumber.toLowerCase().includes(term)) || 
                       (order.customerPhone && order.customerPhone.toLowerCase().includes(term)) ||
                       (order.type && order.type.toLowerCase().includes(term));
            });

            if (filteredOrders.length === 0) {
                noOrdersMessage.classList.remove('hidden');
                 if (searchTerm) {
                    noOrdersMessage.textContent = 'لا توجد طلبات تطابق معايير البحث.';
                } else if (agentOrders.length === 0) {
                     noOrdersMessage.textContent = 'لا توجد طلبات لهذا المندوب حاليًا. قم بإضافة طلب جديد.';
                } else { 
                     noOrdersMessage.textContent = 'لا توجد طلبات تطابق معايير البحث.';
                }
                 deleteAllOrdersForCurrentAgentBtn.classList.add('hidden');
            } else {
                noOrdersMessage.classList.add('hidden');
                deleteAllOrdersForCurrentAgentBtn.classList.remove('hidden');
            }

            filteredOrders.forEach((order, index) => {
                const currentStatusEntry = order.statusHistory[order.statusHistory.length - 1];
                const currentStatus = currentStatusEntry.status;
                const latestStatusSpecificNote = currentStatusEntry.note;

                let statusHtml = `<span class="status-badge status-${sanitizeHTML(currentStatus).replace(/\s+/g, '-')}">${sanitizeHTML(currentStatus)}</span>`;
                if (latestStatusSpecificNote) {
                    statusHtml += ` <small class="status-update-specific-note">${sanitizeHTML(latestStatusSpecificNote)}</small>`;
                }

                row = ordersTableBody.insertRow();
                // Note: The order of cells matches the table headers
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${sanitizeHTML(order.type)}</td>
                    <td>${sanitizeHTML(order.receiptNumber)}</td>
                    <td>${sanitizeHTML(order.customerPhone)}</td>
                    <td>${statusHtml}</td>
                    <td>${sanitizeHTML(order.note || '-')}</td>
                    <td>${formatDate(order.date)}</td>
                    <td class="order-actions-cell">
                        <div class="action-menu-container">
                             <button class="action-menu-toggle" aria-label="خيارات الطلب ${sanitizeHTML(order.receiptNumber)}" data-target-menu="order-menu-${order.id}">&#8942;</button>
                             <div id="order-menu-${order.id}" class="action-menu-content">
                                <button data-order-id="${order.id}" data-agent-id="${agent.id}" class="update-status-btn warning">تغيير الحالة</button>
                                <button data-order-id="${order.id}" data-agent-id="${agent.id}" class="view-history-btn info">تفاصيل السجل</button>
                                <button data-order-id="${order.id}" data-agent-id="${agent.id}" class="delete-order-btn danger">حذف الطلب</button>
                             </div>
                        </div>
                    </td>
                `;
            });

            document.querySelectorAll('.update-status-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const orderId = parseInt(btn.dataset.orderId);
                    const aId = parseInt(btn.dataset.agentId); // Renamed variable
                    const currentAgent = agents.find(d => d.id === aId);
                    if (currentAgent && currentAgent.orders) {
                        const orderToUpdate = currentAgent.orders.find(o => o.id === orderId);
                        if (orderToUpdate) {
                            document.getElementById('updateStatusOrderId').value = orderId;
                            document.getElementById('updateStatusAgentId').value = aId; // Renamed
                            const currentStatus = orderToUpdate.statusHistory[orderToUpdate.statusHistory.length -1].status;
                            populateStatusSelect(orderStatusSelect, currentStatus);
                            statusUpdateNoteTextarea.value = ''; 
                            openModal(updateStatusModal);
                        }
                    }
                     btn.closest('.action-menu-content').classList.remove('show'); // Close menu
                };
            });
            
            document.querySelectorAll('.view-history-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const orderId = parseInt(btn.dataset.orderId);
                    const aId = parseInt(btn.dataset.agentId); // Renamed
                    showOrderHistory(aId, orderId);
                    btn.closest('.action-menu-content').classList.remove('show'); // Close menu
                };
            });
            document.querySelectorAll('.delete-order-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const orderId = parseInt(btn.dataset.orderId);
                    const aId = parseInt(btn.dataset.agentId); // Renamed
                    deleteOrder(aId, orderId);
                    btn.closest('.action-menu-content').classList.remove('show'); // Close menu
                };
            });


            agentsSection.classList.add('hidden');
            agentDetailsSection.classList.remove('hidden');
            
            if (!searchTerm) { 
              agentDetailsSection.focus(); 
              window.scrollTo(0, 0);
            }
            setupActionMenuToggleListeners(); // Re-setup for new menus in table
        }
        
        function showOrderHistory(agentId, orderId) { // Renamed parameter
            const agent = agents.find(d => d.id === agentId);
            if (!agent || !agent.orders) return;
            const order = agent.orders.find(o => o.id === orderId);
            if (!order) return;

            historyOrderReceiptNumberSpan.textContent = sanitizeHTML(order.receiptNumber);
            orderHistoryListUl.innerHTML = '';

            if (!order.statusHistory || order.statusHistory.length === 0) {
                 noHistoryMessage.classList.remove('hidden');
                 orderHistoryListUl.classList.add('hidden');
            } else {
                 noHistoryMessage.classList.add('hidden');
                 orderHistoryListUl.classList.remove('hidden');
                [...order.statusHistory].reverse().forEach(entry => {
                    const li = document.createElement('li');
                    let entryHtml = `<span class="history-status">${sanitizeHTML(entry.status)}</span>
                                     <span class="history-time">${formatDateTime(entry.timestamp)}</span>`;
                    if (entry.note) {
                        entryHtml += `<span class="history-note">ملاحظة: ${sanitizeHTML(entry.note)}</span>`;
                    }
                    li.innerHTML = entryHtml;
                    orderHistoryListUl.appendChild(li);
                });
            }
            openModal(orderHistoryModal);
        }

        // --- Action Menu Toggle Logic ---
        function setupActionMenuToggleListeners() {
            document.querySelectorAll('.action-menu-toggle').forEach(toggle => {
                // Remove existing listener to prevent duplicates if called multiple times
                const newToggle = toggle.cloneNode(true);
                toggle.parentNode.replaceChild(newToggle, toggle);

                newToggle.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent global click listener from closing it immediately
                    const targetMenuId = newToggle.dataset.targetMenu;
                    const menu = document.getElementById(targetMenuId);
                    
                    // Close all other open menus
                    document.querySelectorAll('.action-menu-content.show').forEach(openMenu => {
                        if (openMenu.id !== targetMenuId) {
                            openMenu.classList.remove('show');
                        }
                    });
                    if (menu) {
                        menu.classList.toggle('show');
                    }
                });
            });
        }


        // --- Event Handlers ---
        showAddAgentModalBtn.onclick = () => { // Renamed
            addAgentForm.reset();
            openModal(addAgentModal);
        };

        addAgentForm.onsubmit = (e) => { // Renamed
            e.preventDefault();
            const name = document.getElementById('agentName').value.trim();
            const phone = document.getElementById('agentPhone').value.trim();
            const area = document.getElementById('agentArea').value.trim();

            if (name && phone && area) {
                agents.push({ id: nextAgentId++, name, phone, area, orders: [] });
                saveData();
                renderAgentsList();
                closeModal(addAgentModal);
            }
        };

        showAddOrderModalBtn.onclick = () => {
            if (currentlyViewingAgentId === null) return;
            const agent = agents.find(d => d.id === currentlyViewingAgentId);
            if (agent) {
                addOrderForm.reset();
                document.getElementById('orderAgentId').value = agent.id; // Renamed
                addOrderModalAgentNameSpan.textContent = sanitizeHTML(agent.name); // Renamed
                openModal(addOrderModal);
            }
        };

        addOrderForm.onsubmit = (e) => {
            e.preventDefault();
            const agentId = parseInt(document.getElementById('orderAgentId').value); // Renamed
            const type = document.getElementById('orderType').value.trim();
            const receiptNumber = document.getElementById('receiptNumber').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const note = document.getElementById('orderNote').value.trim();
            const creationTime = new Date().toISOString();

            if (agentId && type && receiptNumber && customerPhone) {
                const agent = agents.find(d => d.id === agentId);
                if (agent) {
                    if (!agent.orders) agent.orders = [];
                    const newOrder = {
                        id: nextOrderId++,
                        type,
                        receiptNumber,
                        customerPhone,
                        status: DEFAULT_ORDER_STATUS, 
                        note, 
                        date: creationTime, 
                        statusHistory: [{
                            status: DEFAULT_ORDER_STATUS,
                            timestamp: creationTime,
                            note: "" 
                        }]
                    };
                    agent.orders.push(newOrder);
                    saveData();
                    renderAgentDetails(agentId, searchInput.value);
                    renderAgentsList(); 
                    closeModal(addOrderModal);
                }
            }
        };
        
        updateStatusForm.onsubmit = (e) => {
            e.preventDefault();
            const orderId = parseInt(document.getElementById('updateStatusOrderId').value);
            const agentId = parseInt(document.getElementById('updateStatusAgentId').value); // Renamed
            const newStatus = document.getElementById('orderStatus').value;
            const updateNote = statusUpdateNoteTextarea.value.trim();

            const agent = agents.find(d => d.id === agentId);
            if (agent && agent.orders) {
                const order = agent.orders.find(o => o.id === orderId);
                if (order) {
                    if (!order.statusHistory) { 
                        order.statusHistory = [];
                    }
                    order.statusHistory.push({
                        status: newStatus,
                        timestamp: new Date().toISOString(),
                        note: updateNote
                    });
                    order.status = newStatus; 

                    saveData();
                    renderAgentDetails(agentId, searchInput.value);
                    renderAgentsList(); 
                    closeModal(updateStatusModal);
                }
            }
        };
        
        function backToAgentsList() { // Renamed
            currentlyViewingAgentId = null;
            agentDetailsSection.classList.add('hidden');
            agentsSection.classList.remove('hidden');
            searchInput.value = '';
            document.getElementById('current-agent-action-menu-container').classList.add('hidden');
            deleteAllOrdersForCurrentAgentBtn.classList.add('hidden');
            agentsSection.focus(); 
            window.scrollTo(0, 0);
        }

        backToAgentsListBtn.onclick = backToAgentsList;
        
        searchInput.oninput = () => {
            if (currentlyViewingAgentId !== null) {
                renderAgentDetails(currentlyViewingAgentId, searchInput.value);
            }
        };
        
        function showAgentDetails(agentId) { // Renamed parameter
            searchInput.value = '';
            renderAgentDetails(agentId);
        }

        // --- Delete Functions ---
        function deleteAgent(agentId) { // Renamed parameter and function content for agent
            const agent = agents.find(d => d.id === agentId);
            if (!agent) return;
            if (window.confirm(`هل أنت متأكد أنك تريد حذف المندوب "${sanitizeHTML(agent.name)}" وجميع طلباته؟`)) {
                agents = agents.filter(d => d.id !== agentId);
                saveData();
                if (currentlyViewingAgentId === agentId) {
                    backToAgentsList();
                }
                renderAgentsList();
            }
        }

        function deleteOrder(agentId, orderId) { // Renamed parameter
            const agent = agents.find(d => d.id === agentId);
            if (!agent || !agent.orders) return;
            const order = agent.orders.find(o => o.id === orderId);
            if(!order) return;

            if (window.confirm(`هل أنت متأكد أنك تريد حذف الطلب رقم "${sanitizeHTML(order.receiptNumber)}؟"`)) {
                agent.orders = agent.orders.filter(o => o.id !== orderId);
                saveData();
                renderAgentDetails(agentId, searchInput.value);
                renderAgentsList(); 
            }
        }
        
        deleteAllAgentsBtn.onclick = () => { // Renamed
            if (agents.length === 0) {
                alert("لا يوجد مندوبون لحذفهم.");
                return;
            }
            if (window.confirm("هل أنت متأكد أنك تريد حذف جميع المندوبين وجميع طلباتهم؟ لا يمكن التراجع عن هذا الإجراء.")) {
                agents = [];
                nextAgentId = 1; 
                nextOrderId = 1;
                saveData();
                if (agentDetailsSection.classList.contains('hidden') === false) { 
                    backToAgentsList();
                }
                renderAgentsList();
            }
        };

        // deleteCurrentAgentBtn is now handled by deleteCurrentAgentMenuBtn inside renderAgentDetails setup

        deleteAllOrdersForCurrentAgentBtn.onclick = () => { // Renamed
            if (currentlyViewingAgentId === null) return;
            const agent = agents.find(d => d.id === currentlyViewingAgentId);
            if (agent && agent.orders && agent.orders.length > 0) {
                if (window.confirm(`هل أنت متأكد أنك تريد حذف جميع طلبات المندوب "${sanitizeHTML(agent.name)}؟"`)) {
                    agent.orders = [];
                    saveData();
                    renderAgentDetails(currentlyViewingAgentId, searchInput.value);
                    renderAgentsList(); 
                }
            } else {
                alert("لا توجد طلبات لحذفها لهذا المندوب.");
            }
        };

        // --- Export CSV Function ---
        function exportReportToCSV() {
            if (agents.length === 0) {
                alert("لا يوجد بيانات لتصديرها كتقرير CSV.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            const header = [
                "اسم المندوب", "هاتف المندوب", "منطقة المندوب",
                "رقم تسلسلي للطلب", "نوع الطلب", "رقم الوصل", "هاتف الزبون",
                "الحالة الحالية", "ملاحظة الحالة الأخيرة", "الملاحظة الرئيسية للطلب", "تاريخ إنشاء الطلب",
                "سجل تغييرات الحالة"
            ];
            csvContent += header.join(",") + "\r\n";

            agents.forEach(agent => {
                if (agent.orders && agent.orders.length > 0) {
                    agent.orders.forEach((order, index) => {
                        const currentStatusEntry = order.statusHistory[order.statusHistory.length - 1];
                        const currentStatus = currentStatusEntry.status;
                        const latestStatusSpecificNote = currentStatusEntry.note;

                        const historyEntries = order.statusHistory.map(h => 
                            `"${h.status} (${formatDateTimeForReport(h.timestamp)})${h.note ? ' - ' + h.note.replace(/"/g, '""') : ''}"`
                        ).join(" | ");

                        const row = [
                            `"${agent.name.replace(/"/g, '""')}"`,
                            `"${agent.phone}"`,
                            `"${agent.area.replace(/"/g, '""')}"`,
                            index + 1,
                            `"${order.type.replace(/"/g, '""')}"`,
                            `"${order.receiptNumber}"`,
                            `"${order.customerPhone}"`,
                            `"${currentStatus.replace(/"/g, '""')}"`,
                            `"${latestStatusSpecificNote.replace(/"/g, '""')}"`,
                            `"${(order.note || '').replace(/"/g, '""')}"`,
                            `"${formatDateTimeForReport(order.date)}"`,
                            `"${historyEntries}"`
                        ];
                        csvContent += row.join(",") + "\r\n";
                    });
                } else {
                    const row = [
                        `"${agent.name.replace(/"/g, '""')}"`,
                        `"${agent.phone}"`,
                        `"${agent.area.replace(/"/g, '""')}"`,
                        "لا توجد طلبات", "", "", "", "", "", "", "", ""
                    ];
                    csvContent += row.join(",") + "\r\n";
                }
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const reportDate = new Date();
            const filename = `تقرير_الطلبات_${reportDate.getFullYear()}-${String(reportDate.getMonth()+1).padStart(2,'0')}-${String(reportDate.getDate()).padStart(2,'0')}.csv`;
            link.setAttribute("download", filename);
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link);
        }
        exportReportBtn.onclick = exportReportToCSV;

        // --- JSON Data Import/Export ---
        function exportDataToJson() {
            if (agents.length === 0 && nextAgentId === 1 && nextOrderId === 1) {
                alert("لا توجد بيانات لتصديرها.");
                return;
            }
            const dataToExport = {
                agents: agents,
                nextAgentId: nextAgentId,
                nextOrderId: nextOrderId
            };
            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const exportDate = new Date();
            const filename = `prototype_backup_${exportDate.getFullYear()}-${String(exportDate.getMonth()+1).padStart(2,'0')}-${String(exportDate.getDate()).padStart(2,'0')}.json`;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        exportDataBtn.onclick = exportDataToJson;

        importDataInput.onchange = (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData && Array.isArray(importedData.agents) && 
                            typeof importedData.nextAgentId === 'number' && 
                            typeof importedData.nextOrderId === 'number') {
                            
                            if (window.confirm("هل أنت متأكد أنك تريد استيراد هذه البيانات؟ سيتم استبدال جميع البيانات الحالية.")) {
                                agents = importedData.agents;
                                nextAgentId = importedData.nextAgentId;
                                nextOrderId = importedData.nextOrderId;
                                // Perform data validation/migration again just in case
                                agents.forEach(agent => {
                                    if (!agent.orders) agent.orders = [];
                                    agent.orders.forEach(order => {
                                        if (!order.statusHistory || order.statusHistory.length === 0) {
                                            order.statusHistory = [{ status: order.status || DEFAULT_ORDER_STATUS, timestamp: order.date || new Date().toISOString(), note: "" }];
                                        }
                                        if(order.statusHistory.length > 0) order.status = order.statusHistory[order.statusHistory.length - 1].status; else order.status = DEFAULT_ORDER_STATUS;
                                    });
                                });
                                saveData();
                                renderAgentsList();
                                if(!agentDetailsSection.classList.contains('hidden')){
                                    backToAgentsList(); // Go back if details view was open
                                }
                                alert("تم استيراد البيانات بنجاح!");
                            }
                        } else {
                            alert("ملف JSON غير صالح أو لا يحتوي على البنية المتوقعة.");
                        }
                    } catch (err) {
                        console.error("Error importing data:", err);
                        alert("حدث خطأ أثناء قراءة أو معالجة ملف JSON.");
                    } finally {
                        importDataInput.value = ''; // Reset file input
                    }
                };
                reader.readAsText(file);
            }
        };


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderAgentsList();
            document.querySelector('main').setAttribute('tabindex', '-1');
            // Initial hide for buttons that depend on data
            deleteAllOrdersForCurrentAgentBtn.classList.add('hidden');
            document.getElementById('current-agent-action-menu-container').classList.add('hidden');
            setupActionMenuToggleListeners(); // Initial setup for any static menus if they existed
        });

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
